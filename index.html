import React, { useMemo, useState } from "react";

// --- DATA INGESTION ---------------------------------------------------------
// Raw category -> plants mapping (taken exactly from your file; no edits)
// Category keys normalized to Title Case without the trailing "type" word.
const CATEGORY_PLANTS: Record<string, string[]> = {
  Berry: [
    "Blueberry",
    "Cranberry",
    "Grape",
    "Raspberry",
    "Strawberry",
    "Celestiberry",
    "White Mulberry",
    "Lingonberry",
    "Elder Strawberry",
  ],
  Root: [
    "Carrot",
    "Mutant Carrot",
    "Chocolate Carrot",
    "Wild Carrot",
    "Taro Flower",
    "Potato",
    "Mandrake",
    "Rhubarb",
    "Onion",
    "Tall Asparagus",
    "Horsetail",
  ],
  Flower: [
    "Candy Blossom",
    "Candy Sunflower",
    "Cherry Blossom",
    "Crocus",
    "Daffodil",
    "Lotus",
    "Orange Tulip",
    "Pink Tulip",
    "Nightshade",
    "Moonflower",
    "Moon Blossom",
    "Rose",
    "Foxglove",
    "Lilac",
    "Pink Lily",
    "Purple Dahlia",
    "Sunflower",
    "Lavender",
    "Honeysuckle",
    "Manuka Flower",
    "Ember Lily",
    "Noble Flower",
    "Bee Balm",
    "Succulent",
    "Parasol Flower",
    "Rosy Delight",
    "Lily Of The Valley",
    "Burning Bud",
    "Rafflesia",
    "Stonebite",
    "Liberty Lily",
    "Firework Flower",
    "Grand Volcania",
    "Serenity",
    "Monoblooma",
    "Soft Sunshine",
    "Hinomai",
    "Taro Flower",
    "Zenflare",
    "Dezen",
    "Artichoke",
    "Veinpetal",
    "Cyclamen",
    "Flare Daisy",
  ],
  Fruit: [
    "Apple",
    "Avocado",
    "Banana",
    "Blueberry",
    "Coconut",
    "Cranberry",
    "Dragon Fruit",
    "Durian",
    "Grape",
    "Lemon",
    "Lime",
    "Mango",
    "Papaya",
    "Passionfruit",
    "Peach",
    "Pear",
    "Pineapple",
    "Raspberry",
    "Strawberry",
    "Watermelon",
    "Starfruit",
    "Blood Banana",
    "Moon Melon",
    "Celestiberry",
    "Moon Mango",
    "Nectarine",
    "Hive Fruit",
    "Green Apple",
    "Sugar Apple",
    "Traveler's Fruit",
    "Loquat",
    "Kiwi",
    "White Mullberry",
    "Lingonberry",
    "Maple Apple",
    "Spiked Mango",
    "Crown Melon",
    "Grand Tomato",
    "Pricklefruit",
    "Mangosteen",
    "Canary Melon",
  ],
  Leafy: [
    "Apple",
    "Blueberry",
    "Cranberry",
    "Eggplant",
    "Grape",
    "Mango",
    "Peach",
    "Pineapple",
    "Pumpkin",
    "Raspberry",
    "Strawberry",
    "Tomato",
    "Watermelon",
    "Cantaloupe",
    "Cacao",
    "Beanstalk",
    "Mint",
    "Moonflower",
    "Starfruit",
    "Moonglow",
    "Moon Blossom",
    "Blood Banana",
    "Celestiberry",
    "Moon Mango",
    "Rose",
    "Foxglove",
    "Lilac",
    "Pink Lily",
    "Purple Dahlia",
    "Sunflower",
    "Nectarine",
    "Hive Fruit",
    "Lumira",
    "Honeysuckle",
    "Noble Flower",
    "Bee Balm",
    "Green Apple",
    "Sugar Apple",
    "Parasol Flower",
    "Elephant Ears",
    "Traveler's Fruit",
    "Rosy Delight",
    "Cauliflower",
    "Aloe Vera",
    "Lily Of The Valley",
    "Pitcher Plant",
    "Rafflesia",
    "Firefly Fern",
    "Giant Pinecone",
    "Serenity",
    "Soft Sunshine",
    "Dragon Sapling",
    "Maple Apple",
    "Spiked Mango",
    "Sakura Bush",
    "Grand Tomato",
    "Artichoke",
    "Twisted Tangle",
    "Log Pumpkin",
    "Mandrake",
    "Cyclamen",
    "Mangosteen",
    "Princess Thorn",
    "Romanesco",
  ],
  Sour: [
    "Cranberry",
    "Lemon",
    "Lime",
    "Passionfruit",
    "Starfruit",
    "Mangosteen",
  ],
  Sweet: [
    "Banana",
    "Blue Lollipop",
    "Blueberry",
    "Candy Blossom",
    "Candy Sunflower",
    "Chocolate Carrot",
    "Easter Egg",
    "Grape",
    "Mango",
    "Peach",
    "Pear",
    "Pineapple",
    "Raspberry",
    "Red Lollipop",
    "Strawberry",
    "Watermelon",
    "Starfruit",
    "Nectar Thorn",
    "Sugar Apple",
    "Moon Melon",
    "Spiked Mango",
    "Sugarglaze",
    "Crown Melon",
    "Mangosteen",
    "Canary Melon",
    "Romanesco",
  ],
  Tropical: [
    "Banana",
    "Coconut",
    "Dragon Fruit",
    "Durian",
    "Mango",
    "Papaya",
    "Passionfruit",
    "Pineapple",
    "Watermelon",
    "Parasol Flower",
    "Cocovine",
    "Starfruit",
  ],
  Vegetable: [
    "Carrot",
    "Wild Carrot",
    "Chocolate Carrot",
    "Corn",
    "Violet Corn",
    "Eggplant",
    "Pepper",
    "Pumpkin",
    "Purple Cabbage",
    "Tomato",
    "Beanstalk",
    "Mint",
    "Dragon Pepper",
    "Cauliflower",
    "Bell Pepper",
    "Taro Flower",
    "Artichoke",
    "Onion",
    "Jalapeno",
    "Tall Asparagus",
    "Grand Tomato",
    "Log Pumpkin",
    "Badlands Pepper",
    "Rhubarb",
    "King Cabbage",
    "Bitter Melon",
    "Mandrake",
    "Mutant Carrot",
    "Romanesco",
  ],
  Woody: [
    "Apple",
    "Avocado",
    "Cacao",
    "Coconut",
    "Durian",
    "Mango",
    "Papaya",
    "Peach",
    "Pear",
    "Moon Blossom",
    "Moon Mango",
    "Nectarine",
    "Hive Fruit",
    "Cocovine",
    "Traveler's Fruit",
    "Kiwi",
    "Feijoa",
    "Giant Pinecone",
    "Dragon Sapling",
    "Maple Apple",
    "Spiked Mango",
    "Sakura Bush",
    "Rhubarb",
    "Duskpuff",
    "Mangosteen",
    "Gleamroot",
    "Amberheart",
  ],
  Prickly: [
    "Cactus",
    "Dragon Fruit",
    "Durian",
    "Pineapple",
    "Venus Fly Trap",
    "Celestiberry",
    "Nectar Thorn",
    "Prickly Pear",
    "Aloe Vera",
    "Horned Dinoshroom",
    "Spiked Mango",
    "Twisted Tangle",
    "Pricklefruit",
    "Princess Thorn",
  ],
  Toxic: [
    "Foxglove",
    "Nightshade",
    "Rafflesia",
    "Pitcher Plant",
    "Horned Dinoshroom",
    "Sinisterdrip",
    "Cursed Fruit",
    "Amber Spine",
  ],
  Fungus: [
    "Mega Mushroom",
    "Mushroom",
    "Glowshroom",
    "Nectarshade",
    "Horned Dinoshroom",
    "Sinisterdrip",
    "Duskpuff",
  ],
  Night: [
    "Blood Banana",
    "Moon Melon",
    "Nightshade",
    "Glowshroom",
    "Mint",
    "Moonflower",
    "Starfruit",
    "Moonglow",
    "Moon Blossom",
    "Moon Mango",
    "Celestiberry",
    "Aura Flora",
    "Gleamroot",
  ],
  Spicy: [
    "Cursed Fruit",
    "Ember Lily",
    "Pepper",
    "Dragon Pepper",
    "Cacao",
    "Horned Dinoshroom",
    "Grand Volcania",
    "Jalapeno",
    "Badlands Pepper",
  ],
  Stalky: [
    "Beanstalk",
    "Burning Bud",
    "Bamboo",
    "Dandelion",
    "Mushroom",
    "Bendboo",
    "Lotus",
    "Elephant Ears",
    "Lily Of The Valley",
    "Pitcher Plant",
    "Stonebite",
    "Firefly Fern",
    "Horned Dinoshroom",
    "Grand Volcania",
    "Soft Sunshine",
    "Hinomai",
    "Sinisterdrip",
    "Lucky Bamboo",
    "Sugarglaze",
    "Tall Asparagus",
    "Veinpetal",
    "Pricklefruit",
    "Spring Onion",
    "Mutant Carrot",
    "Poseidon Plant",
  ],
  Summer: [
    "Carrot",
    "Strawberry",
    "Blueberry",
    "Tomato",
    "Watermelon",
    "Rafflesia",
    "Cauliflower",
    "Green Apple",
    "Avocado",
    "Banana",
    "Pineapple",
    "Kiwi",
    "Bell Pepper",
    "Prickly Pear",
    "Loquat",
    "Feijoa",
    "Pitcher Plant",
    "Sugar Apple",
    "Wild Carrot",
    "Pear",
    "Cantaloupe",
    "Parasol Flower",
    "Rosy Delight",
    "Elephant Ears",
    "Delphinium",
    "Lily Of The Valley",
    "Traveler's Fruit",
    "Peace Lily",
    "Aloe Vera",
    "Guanabana",
    "Butternut Squash",
  ],
  Prehistoric: [
    "Stonebite",
    "Paradise Petal",
    "Horned Dinoshroom",
    "Boneboo",
    "Firefly Fern",
    "Fossilight",
    "Bone Blossom",
    "Horsetail",
    "Lingonberry",
    "Amber Spine",
    "Grand Volcania",
  ],
  Zen: [
    "Monoblooma",
    "Serenity",
    "Taro Flower",
    "Zen Rocks",
    "Hinomai",
    "Maple Apple",
    "Zenflare",
    "Soft Sunshine",
    "Spiked Mango",
    "Sakura Bush",
    "Enkaku",
    "Dezen",
    "Lucky Bamboo",
    "Tranquil Bloom",
  ],
};

// --- HELPERS ---------------------------------------------------------------
const CATEGORY_ORDER = [
  "Berry",
  "Root",
  "Flower",
  "Fruit",
  "Leafy",
  "Sour",
  "Sweet",
  "Tropical",
  "Vegetable",
  "Woody",
  "Prickly",
  "Toxic",
  "Fungus",
  "Night",
  "Spicy",
  "Stalky",
  "Summer",
  "Prehistoric",
  "Zen",
];

const RARITY_EMOJI = {
  very: "üåü",
  common: "‚≠ê",
  moderate: "‚ú¶",
  rare: "‚ùÑÔ∏è",
} as const;

type RarityKey = keyof typeof RARITY_EMOJI;

function computePlantIndex() {
  const plantToCategories = new Map<string, Set<string>>();
  for (const [cat, plants] of Object.entries(CATEGORY_PLANTS)) {
    for (const raw of plants) {
      const name = raw.trim();
      if (!plantToCategories.has(name)) plantToCategories.set(name, new Set());
      plantToCategories.get(name)!.add(cat);
    }
  }
  return plantToCategories;
}

function rarityFromCount(count: number): RarityKey {
  if (count >= 5) return "very";
  if (count >= 3) return "common";
  if (count === 2) return "moderate";
  return "rare";
}

function formatCats(cats: string[]) {
  const orderIndex = Object.fromEntries(CATEGORY_ORDER.map((c, i) => [c, i]));
  return [...cats].sort((a, b) => orderIndex[a] - orderIndex[b]);
}

// Suggest plants that cover the most missing categories, prioritize higher rarity
function getSuggestions(
  plantIndex: Map<string, Set<string>>,
  missing: Set<string>,
  exclude: Set<string>
) {
  const rows = [] as Array<{
    name: string;
    covers: string[];
    score: number; // how many missing categories covered
    rarity: RarityKey;
  }>;

  for (const [name, cats] of plantIndex.entries()) {
    if (exclude.has(name)) continue;
    const overlap = [...cats].filter((c) => missing.has(c));
    const score = overlap.length;
    if (score === 0) continue;
    const rarity = rarityFromCount(cats.size);
    rows.push({ name, covers: overlap, score, rarity });
  }

  rows.sort((a, b) => {
    // First by score desc, then rarity (very > common > moderate > rare), then name
    const rarRank: Record<RarityKey, number> = { very: 3, common: 2, moderate: 1, rare: 0 };
    if (b.score !== a.score) return b.score - a.score;
    if (rarRank[b.rarity] !== rarRank[a.rarity]) return rarRank[b.rarity] - rarRank[a.rarity];
    return a.name.localeCompare(b.name);
  });

  return rows.slice(0, 12); // top 12 suggestions
}

// --- UI --------------------------------------------------------------------
export default function GardenPlannerApp() {
  const plantIndex = useMemo(() => computePlantIndex(), []);
  const allPlants = useMemo(() => Array.from(plantIndex.keys()).sort(), [plantIndex]);
  const totalPlants = allPlants.length; // integrity counter

  const [search, setSearch] = useState("");
  const [rarityFilter, setRarityFilter] = useState<RarityKey | "all">("all");
  const [selected, setSelected] = useState<string | null>(null);
  const [favorites, setFavorites] = useState<string[]>([]);

  const rows = useMemo(() => {
    const list = [] as Array<{ name: string; cats: string[]; rarity: RarityKey }>;
    for (const [name, catSet] of plantIndex.entries()) {
      const cats = formatCats([...catSet]);
      const rarity = rarityFromCount(cats.length);
      list.push({ name, cats, rarity });
    }
    list.sort((a, b) => a.name.localeCompare(b.name));
    return list;
  }, [plantIndex]);

  const filtered = rows.filter((r) => {
    const matchesSearch = r.name.toLowerCase().includes(search.toLowerCase());
    const matchesRarity = rarityFilter === "all" ? true : r.rarity === rarityFilter;
    return matchesSearch && matchesRarity;
  });

  const coveredCats = useMemo(() => {
    const s = new Set<string>();
    for (const fav of favorites) {
      const cats = plantIndex.get(fav);
      if (cats) for (const c of cats) s.add(c);
    }
    return s;
  }, [favorites, plantIndex]);

  const allCatsSet = useMemo(() => new Set<string>(CATEGORY_ORDER), []);
  const missingCats = useMemo(() => {
    const m = new Set(allCatsSet);
    for (const c of coveredCats) m.delete(c);
    return m;
  }, [coveredCats, allCatsSet]);

  const suggestions = useMemo(
    () => getSuggestions(plantIndex, missingCats, new Set(favorites)),
    [plantIndex, missingCats, favorites]
  );

  const selectedCats = selected ? formatCats([...(plantIndex.get(selected) || [])]) : [];
  const selectedRarity: RarityKey | null = selected
    ? rarityFromCount(selectedCats.length)
    : null;

  const toggleFavorite = (name: string) => {
    setFavorites((prev) => (prev.includes(name) ? prev.filter((x) => x !== name) : [...prev, name]));
  };

  return (
    <div className="min-h-screen bg-neutral-950 text-neutral-100 p-4 md:p-6">
      <div className="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-4 gap-4">
        {/* LEFT: Plant list & filters */}
        <div className="lg:col-span-2 bg-neutral-900 rounded-2xl p-4 shadow-xl border border-neutral-800">
          <div className="flex flex-col md:flex-row md:items-center gap-3 mb-4">
            <input
              value={search}
              onChange={(e) => setSearch(e.target.value)}
              placeholder="Search plants..."
              className="w-full md:flex-1 bg-neutral-800 rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"
            />
            <div className="flex items-center gap-2">
              {([
                ["all", "All"],
                ["very", `${RARITY_EMOJI.very} 5+`],
                ["common", `${RARITY_EMOJI.common} 3‚Äì4`],
                ["moderate", `${RARITY_EMOJI.moderate} 2`],
                ["rare", `${RARITY_EMOJI.rare} 1`],
              ] as const).map(([key, label]) => (
                <button
                  key={key}
                  onClick={() => setRarityFilter(key as any)}
                  className={`px-3 py-1.5 rounded-lg border text-sm transition ${
                    rarityFilter === key
                      ? "bg-emerald-600 border-emerald-400"
                      : "bg-neutral-800 border-neutral-700 hover:border-neutral-500"
                  }`}
                >
                  {label}
                </button>
              ))}
            </div>
          </div>

          <div className="flex items-center justify-between mb-3">
            <div className="text-sm opacity-80">Showing {filtered.length} / {rows.length} plants</div>
            <div className="text-sm opacity-80">Integrity check: total plants = <span className="font-semibold">{totalPlants}</span></div>
          </div>

          <div className="h-[520px] overflow-auto rounded-xl border border-neutral-800">
            <table className="w-full text-sm">
              <thead className="sticky top-0 bg-neutral-900">
                <tr className="text-left">
                  <th className="px-3 py-2 w-8">‚òÖ</th>
                  <th className="px-3 py-2">Plant</th>
                  <th className="px-3 py-2">Categories</th>
                  <th className="px-3 py-2 w-20">Fav</th>
                </tr>
              </thead>
              <tbody>
                {filtered.map((r) => (
                  <tr key={r.name} className="border-t border-neutral-800 hover:bg-neutral-900/60">
                    <td className="px-3 py-2">
                      {RARITY_EMOJI[rarityFromCount(r.cats.length)]}
                    </td>
                    <td className="px-3 py-2 font-medium">
                      <button
                        className="hover:underline"
                        onClick={() => setSelected(r.name)}
                        title="View details"
                      >
                        {r.name}
                      </button>
                    </td>
                    <td className="px-3 py-2 text-neutral-300">
                      {r.cats.join(", ")}
                    </td>
                    <td className="px-3 py-2">
                      <button
                        onClick={() => toggleFavorite(r.name)}
                        className={`px-2 py-1 rounded-lg text-xs border transition ${
                          favorites.includes(r.name)
                            ? "bg-emerald-600 border-emerald-400"
                            : "bg-neutral-800 border-neutral-700 hover:border-neutral-600"
                        }`}
                      >
                        {favorites.includes(r.name) ? "Unfavorite" : "Favorite"}
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>

        {/* MIDDLE: Selected details & Suggestions */}
        <div className="lg:col-span-1 flex flex-col gap-4">
          <div className="bg-neutral-900 rounded-2xl p-4 shadow-xl border border-neutral-800">
            <h2 className="text-lg font-semibold mb-3">Selected Plant</h2>
            {selected ? (
              <div>
                <div className="flex items-center gap-2 mb-2">
                  <div className="text-2xl">{selectedRarity ? RARITY_EMOJI[selectedRarity] : ""}</div>
                  <div className="text-xl font-semibold">{selected}</div>
                </div>
                <div className="text-sm mb-3">
                  Categories: {selectedCats.join(", ") || "‚Äî"}
                </div>
                <div className="flex gap-2">
                  <button
                    onClick={() => toggleFavorite(selected)}
                    className={`px-3 py-2 rounded-xl border transition ${
                      favorites.includes(selected)
                        ? "bg-emerald-600 border-emerald-400"
                        : "bg-neutral-800 border-neutral-700 hover:border-neutral-600"
                    }`}
                  >
                    {favorites.includes(selected) ? "Remove from Favorites" : "Add to Favorites"}
                  </button>
                  <button
                    onClick={() => setSelected(null)}
                    className="px-3 py-2 rounded-xl border bg-neutral-800 border-neutral-700 hover:border-neutral-600"
                  >
                    Clear
                  </button>
                </div>
              </div>
            ) : (
              <div className="text-sm opacity-70">Select a plant from the left list to view details.</div>
            )}
          </div>

          <div className="bg-neutral-900 rounded-2xl p-4 shadow-xl border border-neutral-800">
            <h2 className="text-lg font-semibold mb-3">Suggestions (fill the gaps)</h2>
            {suggestions.length === 0 ? (
              <div className="text-sm opacity-70">No suggestions right now ‚Äî all categories seem covered üéâ</div>
            ) : (
              <ul className="space-y-2">
                {suggestions.map((s) => (
                  <li key={s.name} className="flex items-center justify-between gap-3">
                    <div>
                      <div className="font-medium flex items-center gap-2">
                        <span>{RARITY_EMOJI[s.rarity]}</span>
                        <button
                          className="hover:underline"
                          onClick={() => setSelected(s.name)}
                        >
                          {s.name}
                        </button>
                      </div>
                      <div className="text-xs opacity-80">Covers missing: {formatCats(s.covers).join(", ")}</div>
                    </div>
                    <button
                      onClick={() => toggleFavorite(s.name)}
                      className="px-2 py-1 rounded-lg text-xs border bg-neutral-800 border-neutral-700 hover:border-neutral-600"
                    >
                      Favorite
                    </button>
                  </li>
                ))}
              </ul>
            )}
          </div>
        </div>

        {/* RIGHT: Favorites & Coverage */}
        <div className="lg:col-span-1 flex flex-col gap-4">
          <div className="bg-neutral-900 rounded-2xl p-4 shadow-xl border border-neutral-800">
            <h2 className="text-lg font-semibold mb-3">Favorites</h2>
            {favorites.length === 0 ? (
              <div className="text-sm opacity-70">No favorites yet. Click ‚ÄúFavorite‚Äù on any plant to pin it here.</div>
            ) : (
              <ul className="space-y-2">
                {favorites.map((f) => {
                  const cats = formatCats([...(plantIndex.get(f) || [])]);
                  const rar = rarityFromCount(cats.length);
                  return (
                    <li key={f} className="border border-neutral-800 rounded-xl p-2">
                      <div className="flex items-center justify-between">
                        <div className="font-medium flex items-center gap-2">
                          <span>{RARITY_EMOJI[rar]}</span>
                          <button className="hover:underline" onClick={() => setSelected(f)}>
                            {f}
                          </button>
                        </div>
                        <button
                          onClick={() => toggleFavorite(f)}
                          className="px-2 py-1 rounded-lg text-xs border bg-neutral-800 border-neutral-700 hover:border-neutral-600"
                        >
                          Remove
                        </button>
                      </div>
                      <div className="text-xs opacity-80 mt-1">{cats.join(", ")}</div>
                    </li>
                  );
                })}
              </ul>
            )}
          </div>

          <div className="bg-neutral-900 rounded-2xl p-4 shadow-xl border border-neutral-800">
            <h2 className="text-lg font-semibold mb-2">Coverage</h2>
            <div className="grid grid-cols-2 gap-2 text-xs">
              {CATEGORY_ORDER.map((c) => (
                <div
                  key={c}
                  className={`rounded-lg border px-2 py-1 text-center ${
                    coveredCats.has(c)
                      ? "bg-emerald-700/30 border-emerald-600"
                      : "bg-neutral-800 border-neutral-700"
                  }`}
                >
                  {c}
                </div>
              ))}
            </div>
          </div>
        </div>

        {/* BOTTOM: Missing categories summary */}
        <div className="lg:col-span-4 bg-neutral-900 rounded-2xl p-4 shadow-xl border border-neutral-800">
          <h2 className="text-lg font-semibold mb-2">What‚Äôs left to cover</h2>
          {missingCats.size === 0 ? (
            <div className="text-sm">All categories covered ‚Äî great job! üåà</div>
          ) : (
            <div className="text-sm">
              Missing categories: {formatCats([...missingCats]).join(", ")}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
